<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Happy Birthday, Mr. Johnson! | Developer Notes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/css/highlight.css">

  
  <meta name="description" content="This happened a long time ago, when I was supporting production deployment of the large enterprise system of a bank.">
<meta property="og:type" content="article">
<meta property="og:title" content="Happy Birthday, Mr. Johnson!">
<meta property="og:url" content="https://yaskovdev.com/2018/04/30/happy-birthday-mr-johnson/index.html">
<meta property="og:site_name" content="Developer Notes">
<meta property="og:description" content="This happened a long time ago, when I was supporting production deployment of the large enterprise system of a bank.">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://yaskovdev.com/2018/04/30/happy-birthday-mr-johnson/old-geezer.png">
<meta property="article:published_time" content="2018-04-30T08:00:00.000Z">
<meta property="article:modified_time" content="2024-11-28T23:43:52.729Z">
<meta property="article:author" content="Sergey Yaskov">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://yaskovdev.com/2018/04/30/happy-birthday-mr-johnson/old-geezer.png"><meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="wrapper">
    <header id="header">
  <h1 id="title">
    <a href="/">Developer Notes</a>
  </h1>
  <nav>
    
    
      
      <a class="nav-link" href="/">Home</a>
    
      
        <span class="nav-spacer">×</span>
      
      <a class="nav-link" href="/subscribe">Subscribe</a>
    
    
  </nav>
</header>

    <div id="content">
      <article id="post-happy-birthday-mr-johnson" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="headline name">
      Happy Birthday, Mr. Johnson!
    </h2>
  


        <div class="article-meta">
          
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <p>This happened a long time ago, when I was supporting production deployment of the large enterprise system of a bank.</p>
<p>The deployment was not automated. IT support guys with production access were working abroad and making necessary changes. I, as a developer, was telling them what to do via Skype. These people were not familiar with the system. They were not even developers. Because of this, the deployment usually took a very long time. It was already late evening when this happened…</p>
<img src="/2018/04/30/happy-birthday-mr-johnson/old-geezer.png" class="" title="Old Geezer">

<p>Suddenly, a <a target="_blank" rel="noopener" href="https://jenkins.io/">Jenkins</a> job that was deploying a component turned red. That was an unpleasant surprise, as the component was the last one in the long list to deploy. I opened the log and saw that the unit tests had failed. The tests had expected 60 € as the price of a health insurance policy, but the actual price the component calculated was 80 €. That was really weird: nobody had touched the code for a month and all the previous builds were green.</p>
<p>Frankly, the first idea that came to my mind was to ignore the unit tests and continue deployment. After all, that’s how developers usually deal with failing unit tests, isn’t it?</p>
<p>However, that would be too risky this time. People can forgive broken UI layout. But they never forgive any issues with their money.</p>
<p>So I had only one choice: to fix the tests as soon as possible and finish the deployment. I started digging into the error.</p>
<p>“OK”, I thought, “yesterday, everything was fine. Today, the tests failed. This means that either the code changed (though it was not supposed to), or the service was taking in some external data (for example, pricing coefficients) from outside sources, such as a database, resulting in faulty unit tests.”</p>
<p>I started with the first option. I checked the commits history, the history of the job itself. Nothing had changed since last month. Then I went further, and took the green build and the build that failed and compared their <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Sha1sum">checksums</a>. They were identical. This meant definitively that nothing had changed in the code.</p>
<p>Then I switched to the second option. It was a bit trickier as the service itself was the legacy, with thousands of lines of spaghetti code per class. I was looking for any and all signs that the service was consuming something from the outer world. JDBC connection strings, JNDI bindings, REST clients, SFTP to external file system and so on. Nothing, except for one small <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Representational_state_transfer">RESTful service</a> that provided coefficients for the prices. However, that service was properly <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Mock_object">mocked</a> in the unit tests, i.e., the tests were consuming its static fake twin, not the service itself.</p>
<p>The only route left to me was to start digging into the price calculation business logic. That was a daunting task. The logic was written a long time ago and nobody really wanted to touch it. After some time of futile attempts and several questions like, “How much longer should we wait?” from my deployers overseas, my attention was attracted by the following line:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">clientAge</span> <span class="operator">=</span> DateUtil.countAgeUsingPersonalCode(<span class="string">&quot;280752-7918&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>The insurance policy was more expensive than the test expected, right? Insurance usually becomes more expensive as the clients get older. Wait a second…</p>
<p>Today is July 29th. Mr. Johnson (that was the name of the fictional client from the unit tests) celebrated his sixtieth birthday yesterday. And sixty years is one of the frontiers when the price for the insurance gets higher!</p>
<p>Now everything was completely clear to me. The code didn’t change, and the unit tests didn’t consume any services from the outer world; the only outer service was properly mocked. However, one external thing the tests still “consumed” was the time. Yesterday, and all the time before, the tests were passing because Mr. Johnson was still “young” and was eligible for cheaper insurance. Starting from today, however, he turned sixty, the price for his policy increased, while nobody adjusted the tests and they still expected the price to stay the same…</p>
<p>That deployment took a little longer than expected. Still, it was successfully finished. I also created a ticket to make the <code>DateUtil</code> independent on current moment of time and re-write the unit tests. And, most importantly, I learned a good lesson.</p>
<h3 id="The-Lesson-Learned"><a href="#The-Lesson-Learned" class="headerlink" title="The Lesson Learned"></a>The Lesson Learned</h3><p>To make sure that no “Mr. Johnsons” spoil your evening again, never allow your unit tests to depend on <em>anything</em> external. Time is also an external value, though it may seem stable and predictable.</p>
<p>One good way to validate your unit tests can be changing your PC clock to something out-of-date, like to a distant past or future, and check that the tests keep passing without raising false-positive errors.</p>

      
    </div>
    
    
    <div class="article-category">
      
        <b>Categories:</b>
        <a class="article-category-link" href="/categories/development/">development</a>, <a class="article-category-link" href="/categories/development/testing/">testing</a>
      
      
      
    </div>
    
    
  </div>
</article>

  
<nav id="article-nav" class="article-nav">
  
    <a href="/2018/05/28/team-building-is-your-enemy/" id="article-nav-newer" class="article-nav-link-wrap newer">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Team-Building Is Your Enemy
        
      </div>
    </a>
  
  
    <a href="/2018/04/02/the-3-principles-of-effective-problem-solving/" id="article-nav-older" class="article-nav-link-wrap older">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">
        
          The 3 Principles Of Effective Problem Solving
        
      </div>
    </a>
  
</nav>





    <div id="disqus_thread"></div>
    <script>
        /**
         *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
         *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
        /*
        var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        };
        */
        (function() { // DON'T EDIT BELOW THIS LINE
            var disqusShortname = 'yaskovdev';
            var d = document, s = d.createElement('script');
            s.src = 'https://' + disqusShortname + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



    </div>
  </div>
  




<div id="settings-container">
  <div id="dark-mode">dark</div>
  <div id="sans-font">sans</div>
</div>
<script type="text/javascript">
let d=document,r=d.documentElement.style,f=r.setProperty.bind(r),l=localStorage,s=l.getItem('s')||(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches),n=l.getItem('n'),m=d.getElementById("dark-mode"),b=()=>{f('--bg-color','#fafafa');f('--code-bg-color','#f4f4f4');f('--text-color','#212121');f('--secondary-color','#808080');f('--tertiary-color','#b0b0b0');f('--link-color','#b5c8cf');f('--link-hover-color','#618794');f('--link-bg-color','#dae4e7');f('--selection-color','#dae4e7');m.innerHTML="dark"},c=()=>{f('--bg-color','#212121');f('--code-bg-color','#292929');f('--text-color','#fff');f('--secondary-color','#c0c0c0');f('--tertiary-color','#6e6e6e');f('--link-color','#4d6b75');f('--link-hover-color','#96b1bb');f('--link-bg-color','#5d828e');f('--selection-color','#acc1c9');m.innerHTML="light"},o=d.getElementById("sans-font"),e=()=>{f('--body-stack','"Lora", "Georgia", "Times New Roman", serif');o.innerHTML="sans"},g=()=>{f('--body-stack','"Lato", "Lucida Grande", "Lucida Sans Unicode", "Lucida Sans", "Verdana", sans-serif');o.innerHTML="serif"};m.onclick=()=>{if(s==2){s=1;l.setItem('s',s);c()}else{s=2;l.setItem('s',s);b()}};o.onclick=()=>{if(n==2){n=1;l.setItem('n',n);g()}else{n=2;l.setItem('n',n);e()}};if(!s){s=2;l.setItem('s',2)};if(s==1){c()};if(!n){n=2;l.setItem('n',2)};if(n==1){g()};
</script>




</body>
</html>
